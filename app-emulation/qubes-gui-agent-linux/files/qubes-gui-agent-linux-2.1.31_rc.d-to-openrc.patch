--- appvm-scripts/etc/init.d/qubes-gui-agent
+++ appvm-scripts/etc/init.d/qubes-gui-agent

@@ -1,45 +1,27 @@
-#!/bin/sh
-#
-# chkconfig: 345 90 90
-# description: Starts Qubes GUI agent
-#
-# Source function library.
-. /etc/rc.d/init.d/functions
+#!/sbin/runscript
 
 start()
 {
-	echo -n $"Starting Qubes GUI agent:"
-	rm -f /tmp/qubes-session-env /tmp/qubes-session-waiter
-	# start console-kit-daemon
-	/usr/bin/ck-list-sessions > /dev/null 2>&1
-	# pretend tha user is at local console
-	touch /var/run/console/user
-	DISPLAY=:0 /usr/bin/qubes-gui 2> /var/log/qubes/gui-agent.log &
-	export DISPLAY=:0
-	success
-	echo ""
-	return 0
+	export DISPLAY=':0'
+
+	if [ -x '/usr/bin/ck-list-sessions' ]; then {
+
+		rm -f /tmp/qubes-session-env /tmp/qubes-session-waiter
+
+		# start console-kit-daemon
+
+		/usr/bin/ck-list-sessions > /dev/null 2>&1
+
+		# pretend tha user is at local console
+
+		touch /var/run/console/user
+	};
+	fi
+
+	start-stop-daemon --start --env DISPLAY=:0 --exec /usr/bin/qubes-gui --background --make-pidfile --pidfile /run/qubes/qubes-gui.pid --stderr /var/log/qubes/gui-agent.log
 }
 
 stop()
 {
-	echo -n "Stopping Qubes GUI agent:"
-	killall qubes-gui && success || failure
-	echo ""
-	return 0
+	start-stop-daemon --stop --pidfile /run/qubes/gui-agent.pid
 }
-
-case "$1" in
-  start)
-	start
-	;;
-  stop)
-	stop
-	;;
-  *)
-	echo $"Usage: $0 {start|stop}"
-	exit 3
-	;;
-esac
-
-exit $RETVAL
